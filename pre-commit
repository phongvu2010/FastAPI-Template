#!/usr/bin/env python
import io
import subprocess
import sys

from typing import List, Dict, Optional

# --- C·∫§U H√åNH ---
# ƒê·ªãnh nghƒ©a c√°c v√πng cho ph√©p commit d·ª±a tr√™n t√™n nh√°nh
ALLOWED_ZONES: Dict[str, List[str]] = {
    "main": [""],  # Chu·ªói r·ªóng nghƒ©a l√† cho ph√©p t·∫•t c·∫£
    "core/base-platform": [
        "alembic/",
        "app/core/",
        "app/db/",
        "app/static/",
        "app/templates/",
        "app/__init__.py",
        "app/main.py",
        "alembic.ini",
        "docker-compose.yml",
        "Dockerfile",
        "prestart.sh",
        "requirements.txt",
    ],
    "feature/users-module": [
        "app/modules/users/",
        "app/initial_data.py",
    ],
    "feature/documents-module": [
        "app/modules/documents/",
    ],
    "feature/audit-logs-module": [
        "app/modules/documents/",
    ],
}


# --- C√ÅC H√ÄM H·ªñ TR·ª¢ (HELPER FUNCTIONS) ---
def setup_console_encoding() -> None:
    """
    Thi·∫øt l·∫≠p encoding UTF-8 cho stdout/stderr ƒë·ªÉ hi·ªÉn th·ªã Emoji ƒë√∫ng tr√™n Windows.
    """
    if sys.stdout.encoding != "utf-8":
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding="utf-8")

    if sys.stderr.encoding != "utf-8":
        sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding="utf-8")


def run_git_cmd(args: List[str]) -> str:
    """
    Th·ª±c thi l·ªánh git v√† tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng chu·ªói UTF-8.
    """
    try:
        return subprocess.check_output(
            args, stderr=subprocess.DEVNULL
        ).decode("utf-8").strip()
    except subprocess.CalledProcessError:
        return ""


def get_current_branch() -> str:
    """
    L·∫•y t√™n nh√°nh git hi·ªán t·∫°i.
    """
    return run_git_cmd(["git", "symbolic-ref", "--short", "HEAD"])


def get_staged_files() -> List[str]:
    """
    L·∫•y danh s√°ch c√°c file ƒëang trong tr·∫°ng th√°i staged.
    """
    output = run_git_cmd(["git", "diff", "--cached", "--name-only"])
    return output.splitlines() if output else []


def get_allowed_paths_for_branch(branch: str) -> Optional[List[str]]:
    """
    T√¨m danh s√°ch ƒë∆∞·ªùng d·∫´n cho ph√©p d·ª±a tr√™n t√™n nh√°nh hi·ªán t·∫°i.
    H·ªó tr·ª£ kh·ªõp ch√≠nh x√°c ho·∫∑c kh·ªõp ti·ªÅn t·ªë (prefix).
    """
    for rule_branch, paths in ALLOWED_ZONES.items():
        if branch == rule_branch or branch.startswith(rule_branch):
            return paths

    return None


def is_path_allowed(file_path: str, allowed_paths: List[str]) -> bool:
    """
    Ki·ªÉm tra xem file c√≥ n·∫±m trong danh s√°ch ƒë∆∞·ªùng d·∫´n cho ph√©p hay kh√¥ng.
    """
    for allowed in allowed_paths:
        # N·∫øu rule l√† chu·ªói r·ªóng "", cho ph√©p t·∫•t c·∫£
        if allowed == "" or file_path.startswith(allowed):
            return True

    return False


# --- H√ÄM CH√çNH (MAIN) ---
def main() -> None:
    """
    Lu·ªìng x·ª≠ l√Ω ch√≠nh c·ªßa hook.
    """
    setup_console_encoding()

    branch = get_current_branch()
    files_changed = get_staged_files()

    # N·∫øu kh√¥ng c√≥ file n√†o staged (vd: commit r·ªóng), cho qua
    if not files_changed:
        sys.exit(0)

    allowed_paths = get_allowed_paths_for_branch(branch)

    # Tr∆∞·ªùng h·ª£p 1: Nh√°nh kh√¥ng ƒë∆∞·ª£c c·∫•u h√¨nh trong h·ªá th·ªëng
    if allowed_paths is None:
        print(f"‚ùå L·ªñI: Nh√°nh '{branch}' kh√¥ng c√≥ quy·ªÅn commit v√†o b·∫•t k·ª≥ file n√†o.")
        sys.exit(1)

    # Tr∆∞·ªùng h·ª£p 2: Ki·ªÉm tra vi ph·∫°m
    violations = [f for f in files_changed if not is_path_allowed(f, allowed_paths)]

    if violations:
        print(f"\nüîí COMMIT B·ªä CH·∫∂N TR√äN NH√ÅNH: {branch}")
        print("B·∫°n ƒëang c·ªë g·∫Øng commit c√°c file ngo√†i ph·∫°m vi cho ph√©p:")
        for v in violations:
            print(f"  ‚ùå {v}")

        print("\n‚úÖ C√°c ƒë∆∞·ªùng d·∫´n ƒë∆∞·ª£c ph√©p cho nh√°nh n√†y:")
        for p in allowed_paths:
            print(f"  - {p if p else '(T·∫§T C·∫¢)'}")

        print("\nüëâ Vui l√≤ng unstage ho·∫∑c revert c√°c file kh√¥ng h·ª£p l·ªá.")
        sys.exit(1)

    # Tr∆∞·ªùng h·ª£p 3: H·ª£p l·ªá
    print(f"‚úÖ H·ª£p l·ªá! Cho ph√©p commit tr√™n nh√°nh '{branch}'")
    sys.exit(0)


if __name__ == "__main__":
    main()
